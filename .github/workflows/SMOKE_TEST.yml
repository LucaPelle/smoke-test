name: Smoke test
on:
  schedule:
    - cron: '*/30 * * * *'  # Runs every 30 minutes
  workflow_dispatch:
    inputs:
      test_url:
        description: 'URL for smoke test'
        required: false
        default: 'https://casa.pellegriniluca.com'

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    # Set defaults at job level; these can be overridden when the workflow is dispatched
    env:
      URL: ${{ github.event.inputs.test_url || 'https://casa.pellegriniluca.com' }}
      SLACK_WEBHOOK_URL: ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # No browser required for requests-based smoke test

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies (if present)
        run: |
          # Use the Python-provided pip to avoid touching the system-installed pip
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi

      - name: Install Playwright browsers (if Playwright is installed)
        run: |
          python - <<'PY'
          import subprocess, sys
          try:
              import playwright
              print('Playwright package found; installing browsers')
              subprocess.check_call([sys.executable, '-m', 'playwright', 'install'])
          except Exception:
              print('Playwright not installed; skipping browser install')
          PY

      - name: Run smoke test and append output to step summary
        run: |
          echo "ðŸ“œ Console logs:" >> $GITHUB_STEP_SUMMARY
          python smoke_test.py >> $GITHUB_STEP_SUMMARY
